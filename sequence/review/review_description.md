## 필수 정보

### 1. 참여자 (Participants/Actors)
| 참여자 | 설명 | 기술 스택 |
|--------|------|-----------|
| 사용자 (User) | 서비스 이용자 | 브라우저 |
| 프론트엔드 (Frontend) | 웹 클라이언트 | Next.js + Nginx |
| 백엔드 (Backend) | API 서버 | Spring + Spring Security |
| S3 | 이미지 저장소 | AWS S3 |
| OCR 서버 (OCR Server) | 수료증 이미지 인식 서버 | 별도 서버 |
| DB (Database) | 데이터 저장소 | - |

### 2. 시나리오/흐름 설명
- 닉네임 확인 프로세스 (신규)
- 수료증 인증 프로세스
- 강의 후기 작성 프로세스
- 강의 후기 수정 프로세스

> **Note**: 사용자는 후기를 삭제할 수 없습니다. 수정만 가능합니다.
>
> **블라인드 vs 반려 차이 (관리자 기능)**
> - **블라인드(blurred: true)**: 후기가 목록에 **표시됨** (UI 처리는 프론트엔드)
> - **반려(REJECTED)**: 후기가 목록에 **아예 표시되지 않음** (미노출)

### 3. 메시지 흐름 순서

#### 3-0. 닉네임 확인 흐름 (후기 작성 진입 시)
```
1. 사용자 → 프론트엔드: 후기 작성 버튼 클릭
2. 프론트엔드: JWT 토큰에서 hasNickname 플래그 확인
3. [조건] 닉네임 미설정 (hasNickname: false):
   - 프론트엔드 → 사용자: 닉네임 설정 페이지로 이동 안내
   - 사용자 → 프론트엔드: 회원 상세 페이지로 이동
   - 사용자 → 프론트엔드: 닉네임 입력
   - 프론트엔드 → 백엔드: 닉네임 업데이트 요청 (PATCH /api/members/me/nickname)
   - 백엔드 → DB: 닉네임 업데이트
   - DB → 백엔드: 업데이트 완료
   - 백엔드 → 프론트엔드: 200 OK + 새 토큰 발급 (hasNickname: true)
   - 프론트엔드: 새 토큰 저장
   - 프론트엔드 → 사용자: 닉네임 설정 완료, 후기 작성 페이지로 이동
4. [조건] 닉네임 이미 설정됨 (hasNickname: true):
   - 프론트엔드: 수료증 인증 흐름으로 진행
```

#### 3-1. 수료증 인증 흐름
```
1. 사용자 → 프론트엔드: 후기 작성 버튼 클릭
2. 프론트엔드 → 백엔드: 수료증 인증 여부 확인 (GET /api/certificates/check?lectureId={id})
3. 백엔드 → DB: 해당 강의의 수료증 인증 조회 (userId + lectureId)
4. DB → 백엔드: 인증 여부 반환
5. [조건] 수료증 미인증 시:
   - 백엔드 → 프론트엔드: 미인증 응답
   - 프론트엔드 → 사용자: 수료증 인증 모달 표시
   - 사용자 → 프론트엔드: 수료증 이미지 업로드
   - 프론트엔드 → 백엔드: 수료증 인증 요청 (POST /api/certificates/verify, 이미지 포함)
   - 백엔드 → S3: 수료증 이미지 업로드
   - S3 → 백엔드: 이미지 URL 반환
   - 백엔드 → OCR 서버: 이미지 OCR 분석 요청
   - OCR 서버 → 백엔드: OCR 결과 반환 (강의명 등)
   - 백엔드: 강의명 매칭 검증
   - [조건] 인증 성공 시:
     - 백엔드 → DB: 수료증 인증 정보 저장 (certified: true, imageUrl)
     - DB → 백엔드: 저장 완료
     - 백엔드 → 프론트엔드: 인증 성공 응답
     - 프론트엔드 → 사용자: 후기 작성 폼 표시
   - [조건] 인증 실패 시 (OCR 실패 또는 강의명 불일치):
     - 백엔드 → S3: 업로드된 이미지 삭제
     - 백엔드 → 프론트엔드: 인증 실패 응답
     - 프론트엔드 → 사용자: 에러 메시지 표시 ("해당 강의의 수료증이 아닙니다")
6. [조건] 수료증 이미 인증됨:
   - 백엔드 → 프론트엔드: 인증 완료 응답
   - 프론트엔드 → 사용자: 후기 작성 폼 표시
```

#### 3-2. 후기 작성 흐름
```
1. 사용자 → 프론트엔드: 후기 작성 버튼 클릭
2. 프론트엔드 → 백엔드: 후기 작성 가능 여부 확인 (GET /api/reviews/check?lectureId={id})
3. 백엔드 → DB: 기존 후기 존재 여부 조회 (userId + lectureId)
4. DB → 백엔드: 조회 결과 반환
5. [조건] 이미 후기 작성됨:
   - 백엔드 → 프론트엔드: 이미 작성됨 응답
   - 프론트엔드 → 사용자: 알럿 표시 ("이미 작성한 후기입니다")
6. [조건] 후기 작성 가능:
   - 백엔드 → 프론트엔드: 작성 가능 응답
   - 프론트엔드 → 사용자: 후기 작성 폼 표시
   - 사용자 → 프론트엔드: 후기 내용 입력 및 제출 (별점, 후기 콘텐츠, nickname)
   - 프론트엔드 → 백엔드: 후기 작성 API 요청 (POST /api/reviews)
   - 백엔드 → DB: 후기 저장
   - DB → 백엔드: 저장 완료
   - 백엔드 → 프론트엔드: 201 Created (후기 작성 성공)
   - 프론트엔드 → 사용자: 성공 메시지 표시, 강의 상세 페이지로 이동
```

#### 3-3. 후기 수정 흐름

**접근 경로:**
- 강의 상세 페이지 → 본인 후기의 "수정" 버튼
- 마이페이지 → "내가 작성한 후기" → "수정" 버튼

```
1. 사용자 → 프론트엔드: 후기 수정 버튼 클릭
2. 프론트엔드 → 백엔드: 후기 상세 조회 (GET /api/reviews/{reviewId})
3. 백엔드 → DB: 후기 조회
4. DB → 백엔드: 후기 데이터 반환
5. 백엔드 → 프론트엔드: 200 OK (후기 데이터)
6. 프론트엔드 → 사용자: 후기 수정 폼 표시 (기존 데이터 채워짐)
7. 사용자 → 프론트엔드: 수정된 내용 제출 (별점, 후기 콘텐츠)
8. 프론트엔드 → 백엔드: 후기 수정 API 요청 (PUT /api/reviews/{reviewId})
9. 백엔드 → DB: 후기 업데이트
10. DB → 백엔드: 업데이트 완료
11. 백엔드 → 프론트엔드: 200 OK (수정 성공)
12. 프론트엔드 → 사용자: 성공 메시지 표시
```

---

## 선택 정보 (더 정교한 다이어그램을 위해)

### 4. 조건부 흐름 (alt/opt)
| 시나리오 | 분기 조건 |
|----------|-----------|
| 닉네임 확인 | 닉네임 미설정 (hasNickname: false) / 닉네임 설정됨 (hasNickname: true) |
| 수료증 인증 | 미인증 / 이미 인증됨 |
| 수료증 OCR 검증 | 인증 성공 / 인증 실패 (OCR 실패, 강의명 불일치) |
| 후기 작성 | 작성 가능 / 이미 작성됨 |
| 후기 수정 | 없음 (단일 흐름, 본인 후기만 수정 버튼 표시) |

### 5. 반복 (loop)
- 없음

### 6. 병렬 처리 (par)
- 없음

### 7. 비동기 호출
- 모두 동기 호출

### 8. 노트/주석
- 닉네임 확인은 JWT 토큰의 hasNickname 플래그로 판단 (DB 조회 없음)
- 닉네임 설정 완료 시 새 토큰 발급 필요 (hasNickname: true 반영)
- 수료증 이미지는 S3에 저장 (관리자 페이지에서 조회 필요)
- 수료증 인증값은 Boolean (certified: true/false)
- 인증 실패 시 S3에 업로드된 이미지 삭제

---

## 추가 기술 정보

### 인증/인가 방식
| 항목 | 설명 |
|------|------|
| 후기 작성 | 로그인 필수 + 닉네임 설정 필수 + 수료증 인증 필수 |
| 후기 수정 | 로그인 필수 + 작성자 본인만 가능 |
| 수료증 인증 | 로그인 필수 |
| 닉네임 설정 | 로그인 필수 |

> **Note**: 사용자는 후기를 삭제할 수 없습니다. 수정만 가능합니다.

### 데이터 관계
| 관계 | 설명 |
|------|------|
| User : Certificate | 1 : N (유저당 여러 강의 수료증) |
| User : Review (per Lecture) | 1 : 1 (강의당 1개 후기만 작성 가능) |
| Lecture : Review | 1 : N (강의당 여러 후기) |

### 수료증 (Certificates) 테이블
| 필드 | 설명 |
|------|------|
| userId | 사용자 ID (FK) |
| lectureId | 강의 ID (FK) |
| certified | 인증 여부 (Boolean) |
| imageUrl | 수료증 이미지 S3 URL |
| createdAt | 인증 일시 |

### 후기 입력 데이터
| 필드 | 필수 여부 | 설명 |
|------|-----------|------|
| score | 필수 | 전체 별점 (상세 별점 평균) |
| comment | 필수 | 후기 콘텐츠 |
| detailScores | 필수 | 카테고리별 상세 별점 (5개) |

### 상세 별점 카테고리
| 코드 | 카테고리명 |
|------|----------|
| TEACHER | 강사진 |
| CURRICULUM | 커리큘럼(학습지원) |
| MANAGEMENT | 운영 및 학습환경 |
| FACILITY | 취업지원 |
| PROJECT | 프로젝트 |

### API 엔드포인트
| 기능 | Method | Endpoint | 설명 |
|------|--------|----------|------|
| 닉네임 설정 | PATCH | /api/members/me/nickname | 닉네임 업데이트 + 새 토큰 발급 |
| 수료증 인증 여부 확인 | GET | /api/certificates/check | lectureId로 인증 여부 확인 |
| 수료증 인증 요청 | POST | /api/certificates/verify | 이미지 업로드 및 OCR 인증 |
| 후기 작성 가능 여부 확인 | GET | /api/reviews/check | lectureId로 기존 후기 확인 |
| 후기 작성 | POST | /api/reviews | 새 후기 작성 (PENDING 상태) |
| 후기 상세 조회 | GET | /api/reviews/{reviewId} | 후기 단건 조회 |
| 후기 수정 | PUT | /api/reviews/{reviewId} | 후기 수정 |

> **Note**: 사용자 후기 삭제 API는 없습니다. 삭제는 관리자 블라인드 처리로 대체됩니다.

### 에러 케이스
| HTTP Status | 설명 | 발생 조건 |
|-------------|------|-----------|
| 400 Bad Request | 수료증 인증 실패 | OCR 인식 실패 또는 강의명 불일치 |
| 401 Unauthorized | 인증 필요 | 비로그인 상태에서 접근 |
| 409 Conflict | 이미 후기 존재 | 동일 강의에 후기 재작성 시도 |
