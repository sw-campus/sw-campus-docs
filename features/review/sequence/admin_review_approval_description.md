## 필수 정보

### 1. 참여자 (Participants/Actors)
| 참여자 | 설명 | 기술 스택 |
|--------|------|-----------|
| 관리자 (Admin) | 시스템 관리자 | 브라우저 |
| 관리자 프론트엔드 (Admin Frontend) | 관리자 웹 클라이언트 | Next.js + Nginx |
| 백엔드 (Backend) | API 서버 | Spring + Spring Security |
| S3 | 이미지 저장소 | AWS S3 |
| DB (Database) | 데이터 저장소 | - |

### 2. 시나리오/흐름 설명

#### 2단계 관리자 검토 프로세스
관리자는 **수료증 승인**과 **후기 승인**을 단계별 모달을 통해 순차적으로 진행합니다.

| 단계 | 검토 대상 | 설명 |
|------|----------|------|
| 1단계 | 수료증 | 수료증 이미지가 해당 강의의 정당한 수료증인지 확인 |
| 2단계 | 후기 내용 | 후기 내용이 적절한지 확인 (욕설, 광고 등 필터링) |

#### 프로세스 흐름
- 대기 중인 후기 목록 조회 프로세스
- **[1단계 모달]** 수료증 확인 및 승인/반려 프로세스
- **[2단계 모달]** 후기 내용 확인 및 승인/반려 프로세스
- 후기 블라인드 처리 프로세스 (승인된 후기 대상)

> ※ 사용자의 후기 작성 흐름은 기존 review 시퀀스 참고
> ※ 사용자는 OCR 통과 후 바로 후기 작성 가능 (관리자 사후 검토 방식)
> ※ **수료증 반려 시**: 수료증 반려 이메일 발송, 2단계(후기 검토)로 진행하지 않음
> ※ **후기 반려 시**: 후기 반려 이메일 발송 (수료증은 이미 승인된 상태)
> ※ 데이터는 물리적으로 삭제하지 않고 상태 변경 및 블라인드 처리로 관리

### 3. 메시지 흐름 순서

#### 3-1. 대기 중인 후기 목록 조회 흐름
```
1. 관리자 → 관리자 프론트엔드: 후기 관리 메뉴 클릭
2. 관리자 프론트엔드 → 백엔드: 대기 중인 후기 목록 조회 (GET /api/v1/admin/reviews?status=PENDING)
3. 백엔드 → DB: 수료증 또는 후기가 PENDING 상태인 목록 조회
4. DB → 백엔드: 후기 목록 반환 (작성자 정보, 강의 정보, 수료증 승인 상태 포함)
5. 백엔드 → 관리자 프론트엔드: 200 OK (후기 목록 데이터)
6. 관리자 프론트엔드 → 관리자: 대기 중인 후기 목록 표시 (수료증/후기 승인 상태 구분 표시)
```

#### 3-2. [1단계 모달] 수료증 확인 및 승인/반려 흐름
```
1. 관리자 → 관리자 프론트엔드: 후기 항목 클릭 (수료증 미승인 상태)
2. 관리자 프론트엔드 → 백엔드: 수료증 정보 조회 (GET /api/v1/admin/certificates/{certificateId})
3. 백엔드 → DB: 수료증 정보 조회
4. DB → 백엔드: 수료증 정보 반환 (강의명, 수료증 이미지 URL)
5. 백엔드 → 관리자 프론트엔드: 200 OK (수료증 데이터)
6. 관리자 프론트엔드 → S3: 수료증 이미지 요청 (이미지 URL)
7. S3 → 관리자 프론트엔드: 이미지 반환
8. 관리자 프론트엔드 → 관리자: [1단계 모달] 강의명 + 수료증 이미지 표시

[승인 케이스]
9a. 관리자 → 관리자 프론트엔드: "수료증 승인" 버튼 클릭
10a. 관리자 프론트엔드 → 백엔드: 수료증 승인 API 요청 (PATCH /api/v1/admin/certificates/{certificateId}/approve)
11a. 백엔드 → DB: 수료증 승인 상태 업데이트 (approvalStatus: APPROVED)
12a. DB → 백엔드: 업데이트 완료
13a. 백엔드 → 관리자 프론트엔드: 200 OK (승인 완료)
14a. 관리자 프론트엔드 → 관리자: [1단계 모달] 닫고 → [2단계 모달] 자동 표시

[반려 케이스]
9b. 관리자 → 관리자 프론트엔드: "수료증 반려" 버튼 클릭
10b. 관리자 프론트엔드 → 관리자: 반려 확인 모달 표시
11b. 관리자 → 관리자 프론트엔드: 반려 확인
12b. 관리자 프론트엔드 → 백엔드: 수료증 반려 API 요청 (PATCH /api/v1/admin/certificates/{certificateId}/reject)
13b. 백엔드 → DB: 수료증 상태 변경 (approvalStatus: REJECTED)
14b. 백엔드 → 이메일 서버: 수료증 반려 이메일 발송
15b. DB → 백엔드: 처리 완료
16b. 백엔드 → 관리자 프론트엔드: 200 OK (반려 완료)
17b. 관리자 프론트엔드 → 관리자: 반려 완료 메시지 표시, 목록 새로고침
```

> **Note**: 수료증 반려 시 사용자에게 반려 이메일이 발송되며, 2단계(후기 검토)로 진행되지 않습니다.

#### 3-3. [2단계 모달] 후기 내용 확인 및 승인/반려 흐름
```
※ 수료증 승인 후 자동으로 2단계 모달이 표시됩니다

1. 관리자 프론트엔드 → 백엔드: 후기 상세 조회 (GET /api/v1/admin/reviews/{reviewId})
2. 백엔드 → DB: 후기 상세 정보 조회
3. DB → 백엔드: 후기 데이터 반환 (내용, 별점, 세부 점수 등)
4. 백엔드 → 관리자 프론트엔드: 200 OK (후기 상세 데이터)
5. 관리자 프론트엔드 → 관리자: [2단계 모달] 후기 내용 표시

[승인 케이스]
6a. 관리자 → 관리자 프론트엔드: "후기 승인" 버튼 클릭
7a. 관리자 프론트엔드 → 백엔드: 후기 승인 API 요청 (PATCH /api/v1/admin/reviews/{reviewId}/approve)
8a. 백엔드 → DB: 후기 승인 상태 업데이트 (approvalStatus: APPROVED)
9a. DB → 백엔드: 업데이트 완료
10a. 백엔드 → 관리자 프론트엔드: 200 OK (승인 완료)
11a. 관리자 프론트엔드 → 관리자: 승인 완료 메시지 표시, 목록 새로고침

[반려 케이스]
6b. 관리자 → 관리자 프론트엔드: "후기 반려" 버튼 클릭
7b. 관리자 프론트엔드 → 관리자: 반려 확인 모달 표시
8b. 관리자 → 관리자 프론트엔드: 반려 확인
9b. 관리자 프론트엔드 → 백엔드: 후기 반려 API 요청 (PATCH /api/v1/admin/reviews/{reviewId}/reject)
10b. 백엔드 → DB: 후기 상태 변경 (approvalStatus: REJECTED)
11b. 백엔드 → 이메일 서버: 후기 반려 이메일 발송
12b. DB → 백엔드: 처리 완료
13b. 백엔드 → 관리자 프론트엔드: 200 OK (반려 완료)
14b. 관리자 프론트엔드 → 관리자: 반려 완료 메시지 표시, 목록 새로고침
```

> **Note**: 후기 반려 시 사용자에게 후기 반려 이메일이 발송됩니다. (수료증은 이미 승인된 상태)

#### 3-4. 후기 블라인드 처리 흐름 (승인된 후기 대상)
```
1. 관리자 → 관리자 프론트엔드: "블라인드" 버튼 클릭
2. 관리자 프론트엔드 → 관리자: 블라인드 확인 모달 표시
3. 관리자 → 관리자 프론트엔드: 블라인드 확인
4. 관리자 프론트엔드 → 백엔드: 블라인드 API 요청 (PATCH /api/v1/admin/reviews/{reviewId}/blind, blurred: true)
5. 백엔드 → DB: 후기 블라인드 상태 업데이트 (blurred: true)
6. DB → 백엔드: 업데이트 완료
7. 백엔드 → 관리자 프론트엔드: 200 OK (블라인드 완료)
8. 관리자 프론트엔드 → 관리자: 블라인드 완료 메시지 표시, 목록 새로고침
```

> **Note**: 블라인드 해제 시 `blurred: false`로 요청합니다.

---

## 선택 정보 (더 정교한 다이어그램을 위해)

### 4. 조건부 흐름 (alt/opt)
| 시나리오 | 분기 조건 |
|----------|------------|
| 1단계 수료증 승인/반려 | 승인 시 2단계로 진행, 반려 시 반려 이메일 발송 (2단계 진행 안 함) |
| 2단계 후기 승인/반려 | 승인 시 노출, 반려 시 반려 이메일 발송 |

### 5. 반복 (loop)
- 없음

### 6. 병렬 처리 (par)
- 없음

### 7. 비동기 호출
- 모두 동기 호출

### 8. 노트/주석
- 사용자는 OCR 인증 통과 후 바로 후기 작성 가능 (사후 검토 방식)
- **관리자는 2단계로 검토**: 1단계 수료증 → 2단계 후기 내용
- **수료증 승인 후 자동으로 2단계 후기 검토 모달 표시**
- 수료증 이미지는 S3에 저장되어 있음 (review 시퀀스에서 저장)
- **데이터는 물리적으로 삭제하지 않음**
  - 반려: approvalStatus를 REJECTED로 변경
  - 삭제 대체: blurred를 true로 변경 (블라인드 처리)
- **반려 시 이메일 발송**
  - 수료증 반려: 수료증 반려 이메일 발송 (2단계 진행 안 함)
  - 후기 반려: 후기 반려 이메일 발송 (수료증은 이미 승인된 상태)

---

## 추가 기술 정보

### 인증/인가 방식
| 항목 | 설명 |
|------|------|
| 후기 목록 조회 | 관리자 로그인 필수 |
| 수료증 조회/승인/반려 | 관리자 로그인 필수 |
| 후기 조회/승인/반려 | 관리자 로그인 필수 |
| 블라인드 처리 | 관리자 로그인 필수 |

### 수료증 승인 상태
| 상태 | 설명 | 영향 |
|------|------|------|
| PENDING | 승인 대기 | 후기도 미노출 상태 유지 |
| APPROVED | 승인 완료 | 2단계 후기 검토 진행 가능 |
| REJECTED | 반려됨 | **반려 이메일 발송, 2단계 진행 안 함** |

### 후기 승인 상태
| 상태 | 설명 | 노출 여부 |
|------|------|----------|
| PENDING | 승인 대기 | 미노출 (본인에게만 노출 가능) |
| APPROVED | 승인 완료 | 노출 |
| REJECTED | 반려됨 | **미노출 (목록에 아예 안 보임)** |

### 블라인드 상태
| 상태 | 설명 | 노출 여부 |
|------|------|----------|
| blurred: false | 정상 표시 | 내용 전체 노출 |
| blurred: true | 블라인드 처리 | **목록에 표시됨** (UI 처리는 프론트엔드) |

> **블라인드 vs 반려 차이**
> - **블라인드(blurred: true)**: 후기가 목록에 **표시됨** (UI 처리는 프론트엔드에서 결정)
> - **반려(REJECTED)**: 후기가 목록에 **아예 표시되지 않음** (미노출)

### 검토 항목
| 단계 | 검토 대상 | 설명 |
|------|----------|------|
| 1단계 | 수료증 | 해당 강의의 정당한 수료증인지 확인 |
| 2단계 | 후기 내용 | 욕설, 광고, 부적절한 내용 필터링 |

### API 엔드포인트
| 기능 | Method | Endpoint | 설명 |
|------|--------|----------|-------|
| 후기 목록 조회 | GET | /api/v1/admin/reviews | 상태별 필터링 가능 |
| 수료증 조회 | GET | /api/v1/admin/certificates/{certificateId} | 강의명 + 수료증 URL |
| 수료증 승인 | PATCH | /api/v1/admin/certificates/{certificateId}/approve | 1단계 승인 |
| 수료증 반려 | PATCH | /api/v1/admin/certificates/{certificateId}/reject | 반려 이메일 발송 |
| 후기 상세 조회 | GET | /api/v1/admin/reviews/{reviewId} | 2단계 모달용 |
| 후기 승인 | PATCH | /api/v1/admin/reviews/{reviewId}/approve | 2단계 승인 |
| 후기 반려 | PATCH | /api/v1/admin/reviews/{reviewId}/reject | 반려 이메일 발송 |
| 블라인드 처리 | PATCH | /api/v1/admin/reviews/{reviewId}/blind | blurred 상태 변경 (true/false) |

### 에러 케이스
| HTTP Status | 설명 | 발생 조건 |
|-------------|------|-----------|
| 401 Unauthorized | 인증 필요 | 비로그인 또는 관리자 권한 없음 |
| 403 Forbidden | 권한 없음 | 관리자가 아닌 사용자가 접근 |
| 404 Not Found | 리소스 없음 | 존재하지 않는 certificateId 또는 reviewId |
| 409 Conflict | 상태 충돌 | 이미 처리된 리소스 재처리 시도 |
